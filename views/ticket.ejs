<%- include('includes/header.ejs') %>
<main>
    <header class="page-header">
        <h1>Your Tickets</h1>
        <p>Review your journey and stay prepared!!</p>
        <hr>
    </header>
    <div class="dashboard-container">
        <div class="tickets-container">
            <% tickets.forEach(ticket => { %>
                <div class="ticket">
                    <div class="ticket-left">
                        <h3 class="route"><%= ticket.FromStation %> â†’ <%= ticket.ToStation %></h3>
                        <p><strong>Date:</strong> <%= new Date(ticket.DepartureTime).toLocaleDateString() %></p>
                        <p><strong>Time:</strong> <%= new Date(ticket.DepartureTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %></p>
                        <p><strong>Seat:</strong> <%= ticket.SeatNumber %></p>
                    </div>
                    <div class="ticket-right">
                        <p class="price">$<%= ticket.TotalAmount.toFixed(2) %></p>
                        <% if (ticket.IsPaid === 'Yes') { %>
                        <span class="payment-status confirmed">Confirmed</span>
                        <% } else { %>
                        <span class="payment-status pending">Pending Payment</span>
                        <!-- Pay Now Button -->
                        <form id="payForm-<%= ticket.TicketID %>" action="/pay-ticket" method="POST" style="display: inline;">
                            <input type="hidden" name="ticketId" value="<%= ticket.TicketID %>">
                            <input type="hidden" name="paymentCode" id="paymentCode-<%= ticket.TicketID %>">
                            <button 
                                type="button" 
                                class="btn pay-btn" 
                                data-ticket-id="<%= ticket.TicketID %>">
                                Pay Now
                            </button>
                        </form>
                        <% } %>
                        <!-- Delete Button -->
                        <form id="deleteForm-<%= ticket.TicketID %>" action="/delete-ticket" method="POST" style="display: inline;">
                            <input type="hidden" name="ticketId" value="<%= ticket.TicketID %>">
                            <button 
                                type="button" 
                                class="btn delete-btn" 
                                data-ticket-id="<%= ticket.TicketID %>">
                                Delete
                            </button>
                        </form>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>
</main>
<%- include('includes/footer.ejs') %>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    // Find all Pay Now buttons
    const payButtons = document.querySelectorAll(".pay-btn");

    // Attach event listeners to each button
    payButtons.forEach((button) => {
      button.addEventListener("click", function () {
        // Retrieve TicketID from data attribute
        const ticketId = this.getAttribute("data-ticket-id");

        // Prompt the user for a payment code
        const paymentCode = prompt("Please enter your payment code:");

        if (paymentCode) {
          // Set the payment code in the hidden input field
          const paymentCodeInput = document.getElementById(`paymentCode-${ticketId}`);
          if (paymentCodeInput) {
            paymentCodeInput.value = paymentCode;
          }

          // Submit the corresponding form
          const form = document.getElementById(`payForm-${ticketId}`);
          if (form) {
            form.submit();
          }
        } else {
          alert("Payment code is required to proceed.");
        }
      });
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    // Select all delete buttons
    const deleteButtons = document.querySelectorAll(".delete-btn");

    // Add click event listeners to each button
    deleteButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const ticketId = this.getAttribute("data-ticket-id"); // Get TicketID from data attribute
        const isConfirmed = confirm("Are you sure you want to delete this ticket?");
        if (isConfirmed) {
          const form = document.getElementById(`deleteForm-${ticketId}`);
          if (form) {
            form.submit(); // Submit the corresponding form
          } else {
            alert("Form not found. Unable to delete.");
          }
        }
      });
    });
  });
  </script>
</body>
</html>
